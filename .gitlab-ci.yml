# .gitlab-ci.yml - Version 2 (Adding Validate Stage)

# Define the stages in the desired execution order
stages:
 - validate # Run code checks first
 - build    # Build remains for now

default:
 image: node:18 # Default image for all jobs
 tags:
   - docker    # Default tag for all jobs

# --- Validate Stage ---

lint_code:
 stage: validate
 script:
   - echo "Installing dependencies for linting..."
   - npm ci
   - echo "Running linter..."
   - npm run lint # Uses the script we added to package.json

test_code:
 stage: validate
 script:
   - echo "Installing dependencies for testing..."
   - npm ci
   - echo "Running unit tests..."
   - echo "This runs the default Jest test generated by 'cdk init."
   - echo "This basic test usually checks if the stack synthesizes without errors."
   - echo "More comprehensive infrastructure tests can be written but are beyond this chapter's scope."
   - npm run test # Uses the Jest test script

# --- Build Stage ---
# Keep the original build job for now
build_app:
 stage: build
 script:
   - echo "Starting the build process inside $NODE_VERSION..."
   - node -v
   - npm -v
   - echo "Installing dependencies..."
   - npm ci
   - echo "Compiling TypeScript..."
   - npm run build
   - echo "Build finished!"